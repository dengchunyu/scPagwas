---
title: "Running_scPagwas_steps_by_SubFunctions"
date: "Last Updated on `r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Running_scPagwas_steps_by_SubFunctions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Three routine running situations
There are some different situations for running scPagwas!

### 1.1. Run both singlecell and celltypes functions.
```{r eval = FALSE}
library(scPagwas)
Pagwas<-scPagwas_main(Pagwas =NULL,
                     gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
                     Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
                     output.prefix="Test",
                     output.dirs="Test",
                     Pathway_list=Genes_by_pathway_kegg,
                     assay="RNA",
                     singlecell=T, 
                     celltype=T,
                     block_annotation = block_annotation,
                     chrom_ld = chrom_ld)
print(Pagwas)
```
```{r eval = FALSE}
names(Pagwas@meta.data)
# [1] "orig.ident"          "nCount_RNA"          "nFeature_RNA"        "percent.mt"         
# [5] "S.Score"             "G2M.Score"           "Phase"               "old.ident"          
# [9] "nCount_SCT"          "nFeature_SCT"        "SCT_snn_res.0.5"     "seurat_clusters"    
#[13] "SCT_snn_res.0.4"     "SCT_snn_res.0.8"     "anno"                "scPagwas.TRS.Score1"
#[17] "scPagwas.gPAS.score" "CellpValue"          "CellqValue" 
```
- The colomn "scPagwas.TRS.Score1","scPagwas.gPAS.score" is the trait relavent score and genetic pathway score for each cells.
- The colomn "CellpValue" , "CellqValue" is the statistics p value for trait relavent score for each cells.

```{r eval = FALSE}
names(Pagwas@misc)
#[1] "Pathway_list"                  "pca_cell_df"                  
#[3] "lm_results"                    "bootstrap_results"            
#[5] "scPathways_rankPvalue"         "gene_heritability_correlation"
```
- "bootstrap_results" is the cell type results; "scPathways_rankPvalue" is the p value for each pahtway in each celltype; "gene_heritability_correlation" is the correlation result for each gene for genetic pathway score, the top genes were used for calculating the trait relavent score.
- "Pathway_list" ,"pca_cell_df" and "lm_results" are the intermediate results for scPagwas.  


```{r eval = FALSE}
names(Pagwas@assays)
#[1] "RNA"                    "SCT"                    "scPagwasPaHeritability"
#[4] "scPagwasPaPca"
```
the intermediate results "scPagwasPaHeritability" and "scPagwasPaPca" are the additional assays for scPagwas. 
- "scPagwasPaHeritability" is the Heritability score for each pahtway in each cell.
- "scPagwasPaPca"  is the pca score for each pahtway in each cell.

### 1.2. Only run celltypes functions.

The executive programs for celltypes and single cell are independent, If you only want to know the celtypes, set the `celltype=T` and `singlecell=F`.
The advantages is save a lot of times, for celltype only can omit many running processes.

```{r eval = FALSE}
library(scPagwas)
Pagwas_celltypes<-scPagwas_main(Pagwas =NULL,
                     gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
                     Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
                     output.prefix="Test",
                     output.dirs="Test",
                     Pathway_list=Genes_by_pathway_kegg,
                     assay="RNA",
                     singlecell=F, 
                     celltype=T,
                     block_annotation = block_annotation,
                     chrom_ld = chrom_ld)
```

The reuslt of celltypes is list format(not seurat format).
```{r eval = FALSE}
names(Pagwas_celltypes)
# [1] "Celltype_anno"     "data_mat"          "VariableFeatures" 
# [4] "merge_scexpr"      "rawPathway_list"   "Pathway_list"     
# [7] "pca_scCell_mat"    "pca_cell_df"       "snp_gene_df"      
#[10] "lm_results"        "bootstrap_results
```

- bootstrap_results: The bootstrap data frame results for celltypes including bootstrap pvalue and confidence interval.
- pca_scCell_mat : a pahtway and cell data matrix for pathway svd(1'st pca) result for each cell;
- pca_cell_df : a pahtway and celltype data matrix for pathway svd(1'st pca) result for each celltype;

- Other elements are the intermediate data. 

### 1.3. Only run singlecell functions  
Because the parameters and input data are the same with celltypes function, we can take the celltypes result as the input data for single cell function. The advantage is there is no need to 
run the `svd` code block, save a lot of time. 

```{r eval = FALSE}

Pagwas_singlecell<-scPagwas_main(Pagwas =Pagwas_celltypes, 
                                 gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
                                 Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
                                 output.prefix="Test",
                                 output.dirs="Test",
                                 Pathway_list=Genes_by_pathway_kegg,
                                 assay="RNA",
                                 singlecell=T, 
                                 celltype=F,
                                 block_annotation = block_annotation,
                                 chrom_ld = chrom_ld)


```
The result is seurat format.

## 3. Running scPagwas step by step

To utilize and understand scPagwas better, we run scPagwas flexibly step by step. In usual, we needn't run these sub-functions one by one. Most of the steps can founded in 'scPagwas_main' functions.

We use an example provided by scPagwas package.

### 3.1 Single data input

Obtain the single cell expression matrix and filter the cluster for minimum cells.

```{r eval = FALSE}
library(scPagwas)
Pagwas <- list()
Single_data <- readRDS(system.file("extdata", "scRNAexample.rds", package = "scPagwas"))
Pagwas <- Single_data_input(
      Pagwas = Pagwas,
      assay = "RNA",
      Single_data = Single_data,
      Pathway_list = Genes_by_pathway_kegg
    )
Single_data <- Single_data[, colnames(Pagwas$data_mat)]
names(Pagwas)
```

The result list including single cell expression matrix and cell types mean expression matrix.

### 3.2 Run pathway pca score 

Obtain the pathway pca score matrix.

```{r eval = FALSE}
Pagwas <- Pathway_pcascore_run(
        Pagwas = Pagwas,
        Pathway_list = Genes_by_pathway_kegg
      )
names(Pagwas)
```

The result list including `pca_scCell_mat` single cell pca score matrix and `pca_cell_df` cell types pca score matrix.

### 3.3 GWAS summary data input

Read the GWAS summary data, remove the MHC and sex chromosome and filtered the maf of SNP.

```{r eval = FALSE}
gwas_data <- bigreadr::fread2(system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"))
Pagwas <- GWAS_summary_input(
    Pagwas = Pagwas,
    gwas_data = gwas_data,
    maf_filter = 0.1
  )
names(Pagwas)
```

### 3.4 Mapping Snps to Genes

We set the `marg` is 10KB, means the position for SNP is less 10KB distance to TSS of gene.

```{r eval = FALSE}
Pagwas$snp_gene_df <- SnpToGene(
        gwas_data = Pagwas$gwas_data,
        block_annotation = block_annotation,
        marg = 10000
      )
```
SNP to gene dataframe:
```{r eval = FALSE,message=FALSE}
knitr::kable(head(Pagwas$snp_gene_df))
```

### 3.5 Pathway-SNP annotation  
Mapping SNPs to pahtways and getting block data. 
```{r eval = FALSE}
Pagwas <- Pathway_annotation_input(
      Pagwas = Pagwas,
      block_annotation = block_annotation
    )
names(Pagwas)
Pagwas$pathway_blocks[1:3]
```

### 3.6 Link the pathway blocks to pca score 
Also run the regression function for single cell. 
```{r eval = FALSE}
Pagwas <- Link_pathway_blocks_gwas(
      Pagwas = Pagwas,
      chrom_ld = chrom_ld,
      singlecell = T,
      celltype = T,
      backingpath="./temp")
```

The pathway regression result for single cell. 
```{r eval = FALSE}
knitr::kable(Pagwas$Pathway_sclm_results[1:10,1:5])
```

### 3.7 Perform regression for celltypes 
Run the regression function for celltypes. 
```{r eval = FALSE}
Pagwas$lm_results <- Pagwas_perform_regression(Pathway_ld_gwas_data = Pagwas$Pathway_ld_gwas_data)
Pagwas <- Boot_evaluate(Pagwas, bootstrap_iters = 200, part = 0.5)
Pagwas$Pathway_ld_gwas_data <- NULL
```

Show the regression result for celltypes.
```{r eval = FALSE}
names(Pagwas)
Pagwas$lm_results
knitr::kable(Pagwas$bootstrap_results)
```

### 3.8 Construct the scPagwas score
The gPAS scPagwas score mainly to deal with the single-cell regression result.
```{r eval = FALSE}
Pagwas <- scPagwas_perform_score(
      Pagwas = Pagwas,
      remove_outlier = TRUE
    )
names(Pagwas)
```
Show result for Pathway pvalue for each cell types
```{r eval = FALSE}
Pagwas$scPagwas.gPAS.score[1:10]
knitr::kable(head(Pagwas$scPathways_rankPvalue))
```


### 3.9 Get the gene heritability correlation 
Run heritability correlation for all genes.
```{r eval = FALSE}
    Pagwas$gene_heritability_correlation <- scGet_gene_heritability_correlation(scPagwas.gPAS.score=Pagwas$scPagwas.gPAS.score,
                                                                                data_mat=Pagwas$data_mat)

```

The result for correlation: 
```{r eval = FALSE,message=FALSE, warning=FALSE}
knitr::kable(head(Pagwas$gene_heritability_correlation))
```


### 3.10 Calculate the TRS score for top genes. 

Calculate the TRS score for top genes by `AddModuleScore` and running the p value for each cell by `rankPvalue`. 

```{r eval = FALSE,message=FALSE, warning=FALSE}
scPagwas_topgenes <- names(Pagwas$gene_heritability_correlation[order(Pagwas$gene_heritability_correlation, decreasing = T), ])[1:1000]

Single_data <- Seurat::AddModuleScore(Single_data, assay = "RNA", list(scPagwas_topgenes), name = c("scPagwas.TRS.Score"))
#run pvalue
CellScalepValue <- scGene_scaleP(
      Single_mat = t(data.matrix(
        Seurat::GetAssayData(Single_data, assay = 'RNA')[scPagwas_topgenes, ]
      ))
    )
    
```

All these sub-functions for scPagwas can running dependently, but need to run orderly. The `scPagwas_main` function is a wrapper functions for these sub-functions.


## 4. Result Visualization

### 4.1 Visualize the scPagwas Score of single cell data in UMAP or TSNE plot.

1) DimPlot of singlecell data.

```{r eval = FALSE,message=FALSE, warning=FALSE}
 suppressMessages(require("RColorBrewer"))
 suppressMessages(require("Seurat"))
 suppressMessages(require("SeuratObject"))
 suppressMessages(require("ggsci"))
 suppressMessages(require("dplyr"))
 suppressMessages(require("ggplot2"))
 suppressMessages(require("ggpubr"))
 Seurat::DimPlot(Pagwas,pt.size=1,reduction="umap",label = T, repel=TRUE)+
 umap_theme()+ggtitle("Test")+labs(x="UMAP",y="")+theme(aspect.ratio=1)
```


scPagwas.TRS.Score1 and positive(p<0.05) cells showing in dimplot.

```{r eval = FALSE,message=FALSE, warning=FALSE}
 scPagwas_Visualization(Single_data=Pagwas_singlecell,
                        p_thre = 0.05,
                        FigureType = "umap",
                        width = 7,
                        height = 7,
                        lowColor = "white", 
                        highColor = "red",
                        output.dirs="figure",
                        size = 0.5,
                        do_plot = T)
```

### 4.2 Plot the barplot of the proportion of positive Cell. 

Plot the barplot of the proportion of positive Cells in celltypes:
```{r eval = FALSE,message=FALSE, warning=FALSE}
plot_bar_positie_nagtive(seurat_obj=Pagwas_singlecell,
                         var_ident="anno",
                         var_group="positiveCells",
                         vec_group_colors=c("#E8D0B3","#7EB5A6"),
                         do_plot = T)
```

Plot the barplot of the proportion of celltypes in positive and negative Cells:

```{r eval = FALSE,message=FALSE, warning=FALSE}
plot_bar_positie_nagtive(seurat_obj=Pagwas_singlecell,
                              var_ident="positiveCells",
                              var_group="anno",
                              p_thre = 0.01,
                              vec_group_colors=NULL,
                              f_color=colorRampPalette(brewer.pal(n=10, name="RdYlBu")),
                              do_plot = T)
```


### 4.3 Plot the heritability correlated genes

```{r eval = FALSE,message=FALSE, warning=FALSE}
heritability_cor_scatterplot(gene_heri_cor=Pagwas_singlecell@misc$gene_heritability_correlation,
                             topn_genes_label=10,
                             color_low="#035397",
                             color_high ="#F32424",
                             color_mid = "white",
                             text_size=2,
                             do_plot=T,
                             max.overlaps =20,
                             width = 7,
                             height = 7)
```

### 4.4 Show expression of the top heritability correlation genes in celltypes

```{r eval = FALSE,message=FALSE, warning=FALSE}
suppressMessages(library("ggsci"))
suppressMessages(library("Seurat"))
top5genes<-rownames(Pagwas_singlecell@misc$gene_heritability_correlation)[order(Pagwas_singlecell@misc$gene_heritability_correlation,decreasing = T)[c(4,30,36,55)]]
plot_vln_Corgenes(seurat_obj=Pagwas_singlecell,
             assay="RNA", slot="data",
             var_group="anno",
             vec_features=top5genes,
             do_plot = T
             )
```

### 4.6 celltypes bootstrap_results reuslt 
Barplot for celltypes 

```{r eval = FALSE,message=FALSE, warning=FALSE}
Bootstrap_P_Barplot(p_results=Pagwas_singlecell@misc$bootstrap_results$bp_value[-1],
                    p_names=rownames(Pagwas_singlecell@misc$bootstrap_results)[-1],
                    width = 5,
                    height = 7,
                    do_plot=T,
                    title = "Test")
```

Forest plot for estimate value. 
```{r eval = FALSE,message=FALSE, warning=FALSE}
Bootstrap_estimate_Plot(Pagwas=Pagwas_singlecell,
                        width = 9,
                        height = 7,
                        do_plot=T)

```
