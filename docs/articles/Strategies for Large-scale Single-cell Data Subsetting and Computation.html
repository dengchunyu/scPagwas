<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="scPagwas">
<title>Strategies for Large-scale Single-cell Data Subsetting and Computation • scPagwas</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Strategies for Large-scale Single-cell Data Subsetting and Computation">
<meta property="og:description" content="scPagwas">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">scPagwas</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Conventional%20Parameters%20and%20Usage%20Instructions%20with%20Demo%20Example%20Data.html">Conventional Parameters and Usage Instructions with Demo Example Data</a>
    <a class="dropdown-item" href="../articles/Conventional%20result%20and%20visualization%20Instructions%20with%20Real-World%20Examples.html">Conventional result and visualization Instructions with Real-World Examples</a>
    <a class="dropdown-item" href="../articles/Introduction%20to%20Data%20Input%20and%20Preprocessing%20in%20scPagwas.html">Introduction to Data Input and Preprocessing in scPagwas</a>
    <a class="dropdown-item" href="../articles/Perform%20calculations%20for%20multiple%20traits%20based%20on%20a%20single-cell%20dataset.html">Perform calculations for multiple traits based on a single-cell dataset</a>
    <a class="dropdown-item" href="../articles/Pruning%20Process%20for%20GWAS%20Summary%20Statistics%20File%20in%20scPagwas.html">Pruning Process for GWAS Summary Statistics File in scPagwas</a>
    <a class="dropdown-item" href="../articles/Strategies%20for%20Large-scale%20Single-cell%20Data%20Subsetting%20and%20Computation.html">Strategies for Large-scale Single-cell Data Subsetting and Computation</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Strategies for Large-scale Single-cell Data Subsetting and Computation</h1>
            
            <h4 data-toc-skip class="date">Last Updated: 31, 五月, 2023
at 09:28</h4>
      
      
      <div class="d-none name"><code>Strategies for Large-scale Single-cell Data Subsetting and Computation.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scPagwas</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="strategies-for-large-scale-single-cell-data-subsetting-and-computation">Strategies for Large-scale Single-cell Data Subsetting and
Computation<a class="anchor" aria-label="anchor" href="#strategies-for-large-scale-single-cell-data-subsetting-and-computation"></a>
</h2>
<p><code>If your computer storage is enough, ignore this item</code>.</p>
<p>With the rapid development of single-cell data analysis in recent
years, the number of single cells has also increased significantly.
Analyzing the entire single-cell expression matrix can sometimes lead to
memory overflow, making it difficult for many individuals to run
scPagwas with the required amount of memory. To address this issue, we
provide two solutions corresponding to different memory situations:</p>
<ol style="list-style-type: decimal">
<li><p>Solution 1: If there is enough memory to load all the single-cell
data and run until the “Pathway_pcascore_run” function without
encountering memory overflow, the solution involves splitting the data
after this step.</p></li>
<li>
<p>Solution 2: If there is not enough memory to run the
“Pathway_pcascore_run” function, the solution involves splitting the
data based on the initial input of single-cell data.</p>
<p>Please note that both of these approaches are specific to single-cell
data processing. For cell type calculations, large memory requirements
are typically not necessary. If there is still insufficient memory, an
alternative approach is to randomly select a subset of single cells,
ensuring that each cell type is adequately represented in the subset.
Cell type calculations can then be performed based on this subset, as it
represents a pseudo-bulk analysis. However, this vignette does not cover
cell type calculations.</p>
</li>
</ol>
<div class="section level3">
<h3 id="solution-1">1.Solution 1<a class="anchor" aria-label="anchor" href="#solution-1"></a>
</h3>
<div class="section level4">
<h4 id="input-and-compute-the-single-cell-data-">1.1 Input and compute the single-cell data.<a class="anchor" aria-label="anchor" href="#input-and-compute-the-single-cell-data-"></a>
</h4>
<p>Solution 1 involves following the scPagwas workflow and proceeding
with the calculations until the second step:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scPagwas</span><span class="op">)</span></span>
<span><span class="va">Pagwas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#Input and preprocess the single-cell data</span></span>
<span><span class="va">Single_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"scRNAexample.rds"</span>, package <span class="op">=</span> <span class="st">"scPagwas"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Pagwas</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Single_data_input.html">Single_data_input</a></span><span class="op">(</span></span>
<span>      Pagwas <span class="op">=</span> <span class="va">Pagwas</span>,</span>
<span>      assay <span class="op">=</span> <span class="st">"RNA"</span>,</span>
<span>      Single_data <span class="op">=</span> <span class="va">Single_data</span>,</span>
<span>      Pathway_list <span class="op">=</span> <span class="va">Genes_by_pathway_kegg</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">Single_data</span> <span class="op">&lt;-</span> <span class="va">Single_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Pagwas</span><span class="op">$</span><span class="va">data_mat</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#Run svd function</span></span>
<span><span class="va">Pagwas</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Pathway_pcascore_run.html">Pathway_pcascore_run</a></span><span class="op">(</span></span>
<span>        Pagwas <span class="op">=</span> <span class="va">Pagwas</span>,</span>
<span>        Pathway_list <span class="op">=</span> <span class="va">Genes_by_pathway_kegg</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span><span class="va">Pagwas</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/pa_meanexpr.html">pa_meanexpr</a></span><span class="op">(</span><span class="va">Pagwas</span><span class="op">)</span></span>
<span><span class="co">#save this result</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">Pagwas</span>,file<span class="op">=</span><span class="st">"./single.pagwas.RData"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="the-single-cell-processing-results-will-be-divided-into-different-groups-and-saved-as-output">1.2 The single-cell processing results will be divided into
different groups and saved as output<a class="anchor" aria-label="anchor" href="#the-single-cell-processing-results-will-be-divided-into-different-groups-and-saved-as-output"></a>
</h4>
<p>In this step, the number of divisions to which the data will be split
depends on the size of the computer’s memory.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scPagwas</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">seudata_path</span><span class="op">=</span><span class="st">"./single.pagwas.RData"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="va">seudata_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#In this case, the data will be divided into two partitions.</span></span>
<span><span class="va">n</span><span class="op">=</span><span class="fl">2</span></span>
<span><span class="va">an</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Pagwas</span><span class="op">$</span><span class="va">pca_scCell_mat</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">=</span><span class="va">an</span><span class="op">/</span><span class="va">n</span></span>
<span><span class="va">m</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pca_scCell_mat</span><span class="op">&lt;-</span><span class="va">Pagwas</span><span class="op">$</span><span class="va">pca_scCell_mat</span></span>
<span><span class="va">data_mat</span><span class="op">&lt;-</span><span class="va">Pagwas</span><span class="op">$</span><span class="va">data_mat</span></span>
<span></span>
<span><span class="co">#Here's an example code snippet to loop through and output each partitioned data:</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">i</span><span class="op">*</span><span class="va">m</span> <span class="op">&gt;</span> <span class="va">an</span><span class="op">)</span><span class="op">{</span></span>
<span>     <span class="va">Pagwas</span><span class="op">$</span><span class="va">pca_scCell_mat</span><span class="op">=</span><span class="va">pca_scCell_mat</span><span class="op">[</span>,<span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">m</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">an</span><span class="op">]</span> </span>
<span>     <span class="va">Pagwas</span><span class="op">$</span><span class="va">data_mat</span><span class="op">=</span><span class="va">data_mat</span><span class="op">[</span>,<span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">m</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">*</span><span class="va">m</span><span class="op">)</span><span class="op">]</span></span>
<span>     <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>     <span class="va">Pagwas</span><span class="op">$</span><span class="va">pca_scCell_mat</span><span class="op">=</span><span class="va">pca_scCell_mat</span><span class="op">[</span>,<span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">m</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">*</span><span class="va">m</span><span class="op">)</span><span class="op">]</span></span>
<span>     <span class="va">Pagwas</span><span class="op">$</span><span class="va">data_mat</span><span class="op">=</span><span class="va">data_mat</span><span class="op">[</span>,<span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">m</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">*</span><span class="va">m</span><span class="op">)</span><span class="op">]</span></span>
<span>     <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">Pagwas</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">i</span>,<span class="st">"_Pagwas_singledata.RData"</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="input-the-gwas-data-and-save-output">1.3 Input the gwas data and save output<a class="anchor" aria-label="anchor" href="#input-the-gwas-data-and-save-output"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gwasfile</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"GWAS_summ_example.txt"</span>, package <span class="op">=</span> <span class="st">"scPagwas"</span><span class="op">)</span></span>
<span><span class="va">out_file</span><span class="op">=</span> <span class="st">"./gwas_pagwas.RData"</span></span>
<span><span class="va">Pagwas</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gwas_data</span> <span class="op">&lt;-</span> <span class="fu">bigreadr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bigreadr/man/fread2.html" class="external-link">fread2</a></span><span class="op">(</span><span class="va">gwasfile</span><span class="op">)</span></span>
<span><span class="va">Pagwas</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/GWAS_summary_input.html">GWAS_summary_input</a></span><span class="op">(</span></span>
<span>    Pagwas <span class="op">=</span> <span class="va">Pagwas</span>,</span>
<span>    gwas_data <span class="op">=</span> <span class="va">gwas_data</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">Pagwas</span><span class="op">$</span><span class="va">snp_gene_df</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/SnpToGene.html">SnpToGene</a></span><span class="op">(</span>gwas_data <span class="op">=</span> <span class="va">Pagwas</span><span class="op">$</span><span class="va">gwas_data</span>,</span>
<span>        block_annotation <span class="op">=</span> <span class="va">block_annotation</span>,</span>
<span>        marg <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">Pagwas</span>,file<span class="op">=</span><span class="va">out_file</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="the-core-computational-pathway-for-the-regression-process">1.4 The core computational pathway for the regression process<a class="anchor" aria-label="anchor" href="#the-core-computational-pathway-for-the-regression-process"></a>
</h4>
<p>Given that we have divided the single-cell results into two
partitions, the following code illustrates the regression process using
one of the partitions as an example.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gwas_path</span> <span class="op">&lt;-</span> <span class="st">"gwas_pagwas.RData"</span></span>
<span><span class="va">scmat_path</span> <span class="op">&lt;-</span> <span class="st">"1_Pagwas_singledata.RData"</span></span>
<span><span class="co">#scmat_path &lt;- "2_Pagwas_singledata.RData"</span></span>
<span></span>
<span><span class="co">#Import and integrate the two data results into a single list.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="va">gwas_path</span><span class="op">)</span></span>
<span><span class="va">Pagwas1</span><span class="op">&lt;-</span><span class="va">Pagwas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">Pagwas</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="va">scmat_path</span><span class="op">)</span></span>
<span><span class="va">Pagwas</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Pagwas1</span>,<span class="va">Pagwas</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">Pagwas1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">output.prefix</span><span class="op">=</span><span class="st">'1'</span></span>
<span><span class="co">#output.prefix='2'</span></span>
<span><span class="va">output.dirs</span><span class="op">=</span><span class="st">'Test'</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">output.dirs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">output.dirs</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">output.dirs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"./"</span>, <span class="va">output.dirs</span>, <span class="st">"/temp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">Pagwas</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Pathway_annotation_input.html">Pathway_annotation_input</a></span><span class="op">(</span></span>
<span>      Pagwas <span class="op">=</span> <span class="va">Pagwas</span>,</span>
<span>      block_annotation <span class="op">=</span> <span class="va">block_annotation</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">Pagwas</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Link_pathway_blocks_gwas.html">Link_pathway_blocks_gwas</a></span><span class="op">(</span></span>
<span>      Pagwas <span class="op">=</span> <span class="va">Pagwas</span>,</span>
<span>      chrom_ld <span class="op">=</span> <span class="va">chrom_ld</span>,</span>
<span>      singlecell <span class="op">=</span> <span class="cn">T</span>,</span>
<span>      celltype <span class="op">=</span> <span class="cn">F</span>,</span>
<span>      backingpath<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"./"</span>, <span class="va">output.dirs</span>, <span class="st">"/temp"</span><span class="op">)</span>,</span>
<span>      n.cores<span class="op">=</span><span class="fl">1</span></span>
<span>      <span class="op">)</span></span>
<span><span class="va">pmat</span><span class="op">&lt;-</span><span class="va">Pagwas</span><span class="op">$</span><span class="va">Pathway_sclm_results</span></span>
<span></span>
<span><span class="co">#save result</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">pmat</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"./"</span>, <span class="va">output.dirs</span>, <span class="st">"/"</span>,<span class="va">output.prefix</span>,<span class="st">"_Pathway_sclm_results.RData"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#save(pmat,file=paste0("./", output.dirs, "/",output.prefix,"_Pathway_sclm_results.RData"))</span></span></code></pre></div>
<p>Here, it is necessary to run all the split single-cell data
separately, and obtain the “_Pathway_sclm_results.RData” result for each
one.</p>
</div>
<div class="section level4">
<h4 id="aggregate-all-the-single-cell-regression-results-after-splitting-">1.5 Aggregate all the single-cell regression results after
splitting.<a class="anchor" aria-label="anchor" href="#aggregate-all-the-single-cell-regression-results-after-splitting-"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"./"</span>, <span class="va">output.dirs</span>, <span class="st">"/1_Pathway_sclm_results.RData"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n</span><span class="op">=</span><span class="fl">2</span></span>
<span><span class="va">pmat_merge</span><span class="op">&lt;-</span><span class="va">pmat</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"./"</span>, <span class="va">output.dirs</span>, <span class="st">"/"</span>,<span class="va">i</span>,<span class="st">"_Pathway_sclm_results.RData"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">pmat_merge</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pmat_merge</span>,<span class="va">pmat</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">pmat_merge</span>,file<span class="op">=</span><span class="st">"pmat_merge.RData"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="calculating-the-scpagwas-gpas-score-and-genetic-association-gene">1.6 Calculating the scPagwas.gPAS.score and genetic association
gene<a class="anchor" aria-label="anchor" href="#calculating-the-scpagwas-gpas-score-and-genetic-association-gene"></a>
</h4>
<p>After calculating the scPagwas.gPAS.score, genetic association gene
analysis is performed based on this score.</p>
<p>In this process, 200 cells are randomly sampled from the large-scale
single-cell data for computation. This process is repeated five times,
and the results are integrated to obtain the final heritability
correlation.</p>
<p>The number of cells randomly selected and the number of random
iterations depend on the specific quantity of single cells
available.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Note: Here, we need to import the "single.pagwas.RData" data again.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"single.pagwas.RData"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"pmat_merge.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#compute the gPas score.</span></span>
<span><span class="va">scPagwas.gPAS.score</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Merge_gPas.html">Merge_gPas</a></span><span class="op">(</span><span class="va">Pagwas</span>,<span class="va">pmat_merge</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#compute the heritability correlation for each gene. </span></span>
<span><span class="va">gene_heritability_correlation</span><span class="op">&lt;-</span><span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Corr_Random.html">Corr_Random</a></span><span class="op">(</span><span class="va">Pagwas</span><span class="op">$</span><span class="va">data_mat</span>,</span>
<span>                                                     <span class="va">scPagwas.gPAS.score</span>,</span>
<span>                                                     seed<span class="op">=</span><span class="fl">1234</span>,</span>
<span>                                                     random<span class="op">=</span><span class="cn">T</span>,</span>
<span>                                                     Nrandom<span class="op">=</span><span class="fl">5</span>,</span>
<span>                                                     Nselect<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">scPagwas_topgenes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gene_heritability_correlation</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">gene_heritability_correlation</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="compute-the-trs-and-background-correction-p-values-">1.7 Compute the TRS and background correction p-values.<a class="anchor" aria-label="anchor" href="#compute-the-trs-and-background-correction-p-values-"></a>
</h4>
<p>In this step, we need to utilize the initially imported single-cell
data once again.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Single_data</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://satijalab.org/seurat/reference/AddModuleScore.html" class="external-link">AddModuleScore</a></span><span class="op">(</span><span class="va">Single_data</span>,</span>
<span>        assay <span class="op">=</span> <span class="st">'RNA'</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">scPagwas_topgenes</span><span class="op">)</span>,</span>
<span>        name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"scPagwas.TRS.Score"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span><span class="va">correct_pdf</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Get_CorrectBg_p.html">Get_CorrectBg_p</a></span><span class="op">(</span>Single_data<span class="op">=</span><span class="va">Single_data</span>,</span>
<span>                                     scPagwas.TRS.Score<span class="op">=</span><span class="va">Single_data</span><span class="op">$</span><span class="va">scPagwas.TRS.Score1</span>,</span>
<span>                                     iters_singlecell<span class="op">=</span><span class="fl">100</span>,</span>
<span>                                     n_topgenes<span class="op">=</span><span class="fl">500</span>,</span>
<span>                                     scPagwas_topgenes<span class="op">=</span><span class="va">scPagwas_topgenes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Pagwas</span><span class="op">$</span><span class="va">Random_Correct_BG_pdf</span> <span class="op">&lt;-</span> <span class="va">correct_pdf</span></span>
<span><span class="va">Pagwas</span><span class="op">$</span><span class="va">Merged_celltype_pvalue</span><span class="op">&lt;-</span><span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Merge_celltype_p.html">Merge_celltype_p</a></span><span class="op">(</span>single_p<span class="op">=</span><span class="va">correct_pdf</span><span class="op">$</span><span class="va">pooled_p</span>,</span>
<span>                                                          celltype<span class="op">=</span><span class="va">Pagwas</span><span class="op">$</span><span class="va">Celltype_anno</span><span class="op">$</span><span class="va">annotation</span><span class="op">)</span></span></code></pre></div>
<p>All the results can be found in the Pagwas result list.</p>
</div>
</div>
<div class="section level3">
<h3 id="solution-2">2.Solution 2<a class="anchor" aria-label="anchor" href="#solution-2"></a>
</h3>
<div class="section level4">
<h4 id="splice-scrna-seq-data">2.1. Splice scRNA-seq data<a class="anchor" aria-label="anchor" href="#splice-scrna-seq-data"></a>
</h4>
<p>In the second approach, the single-cell data was initially divided
into several partitions, and then each partition was individually
processed using scPagwas. When you split the scRNA-seq data in random,
you should set the min_clustercells=1.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="va">Single_data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"scRNAexample.rds"</span>, package <span class="op">=</span> <span class="st">"scPagwas"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#set the number of split time, it depend on the size of your single cell data.</span></span>
<span><span class="co">#There have two form of spliting the data:</span></span>
<span></span>
<span><span class="co">#Create the random index number.</span></span>
<span><span class="va">n_split</span><span class="op">=</span><span class="fl">2</span></span>
<span><span class="va">Split_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_split</span>, time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Single_data</span><span class="op">)</span><span class="op">/</span><span class="va">n_split</span><span class="op">)</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Single_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_split</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Example_splice</span> <span class="op">&lt;-</span> <span class="va">Single_data</span><span class="op">[</span>,<span class="va">Split_index</span><span class="op">==</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">Example_splice</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Example_splice"</span>,<span class="va">i</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="run-gwas-data-input">2.2. Run gwas data input<a class="anchor" aria-label="anchor" href="#run-gwas-data-input"></a>
</h4>
<p>Second, we run the <code>GWAS_summary_input</code> and
<code>Snp2Gene</code> firstly, because the following function share the
same gwas data. Sometimes, we need not run these functions for small
gwas data, because a little time for these functions.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Pagwas</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gwas_data</span> <span class="op">&lt;-</span> <span class="fu">bigreadr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bigreadr/man/fread2.html" class="external-link">fread2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"GWAS_summ_example.txt"</span>, package <span class="op">=</span> <span class="st">"scPagwas"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Pagwas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GWAS_summary_input.html">GWAS_summary_input</a></span><span class="op">(</span></span>
<span>    Pagwas <span class="op">=</span> <span class="va">Pagwas</span>,</span>
<span>    gwas_data <span class="op">=</span> <span class="va">gwas_data</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">Pagwas</span><span class="op">$</span><span class="va">snp_gene_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SnpToGene.html">SnpToGene</a></span><span class="op">(</span>gwas_data <span class="op">=</span> <span class="va">Pagwas</span><span class="op">$</span><span class="va">gwas_data</span>, </span>
<span>                                block_annotation <span class="op">=</span> <span class="va">block_annotation</span>, marg <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Pagwas</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="run-scpagwas-for-sub-data">2.3. Run scPagwas for sub-data<a class="anchor" aria-label="anchor" href="#run-scpagwas-for-sub-data"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_split</span><span class="op">)</span> <span class="op">{</span></span>
<span> <span class="fu"><a href="../reference/scPagwas_main.html">scPagwas_main</a></span><span class="op">(</span>Pagwas <span class="op">=</span><span class="va">Pagwas</span>,</span>
<span>                     gwas_data <span class="op">=</span><span class="cn">NULL</span>,</span>
<span>                     Single_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Example_splice"</span>,<span class="va">i</span>,<span class="st">".rds"</span><span class="op">)</span>, <span class="co">#the </span></span>
<span>                     output.prefix<span class="op">=</span><span class="va">i</span>, <span class="co">#the prefix can be the circulation coefficient i.</span></span>
<span>                     output.dirs<span class="op">=</span><span class="st">"splice_scPagwas"</span>, <span class="co">#the output.dirs shoukd be the same for each circulation</span></span>
<span>                     Pathway_list<span class="op">=</span><span class="va">Genes_by_pathway_kegg</span>,</span>
<span>                     run_split<span class="op">=</span><span class="cn">TRUE</span>, <span class="co">#You must set the key parameter.This parameter is set to run single result for each split result.</span></span>
<span>                     min_clustercells<span class="op">=</span><span class="fl">10</span>, <span class="co">#the minimum cluster cell number should be 1.</span></span>
<span>                     assay<span class="op">=</span><span class="st">"RNA"</span>,</span>
<span>                     block_annotation <span class="op">=</span> <span class="va">block_annotation</span>,</span>
<span>                     chrom_ld <span class="op">=</span> <span class="va">chrom_ld</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="integrate-the-gpas-score-result-for-splice-data-">2.4. Integrate the gPAS.score result for splice data.<a class="anchor" aria-label="anchor" href="#integrate-the-gpas-score-result-for-splice-data-"></a>
</h4>
<p>Read all the “_singlecell_scPagwas.gPAS.score.Result.csv” result
files and integrate them together.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output.dirs</span><span class="op">=</span><span class="st">"splice_scPagwas"</span></span>
<span><span class="va">oriDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"./"</span>,<span class="va">output.dirs</span><span class="op">)</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">oriDir</span>, pattern<span class="op">=</span><span class="st">"*_singlecell_scPagwas.gPAS.score.Result.csv"</span><span class="op">)</span></span>
<span><span class="co">#integrate the scPagwas.gPAS.score</span></span>
<span><span class="va">scPagwas.gPAS.score</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">files</span>,<span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">gs</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span>file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">oriDir</span>,<span class="st">"/"</span>,<span class="va">file</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">ga</span> <span class="op">&lt;-</span> <span class="va">gs</span><span class="op">$</span><span class="va">scPagwas.gPAS.score</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ga</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">gs</span><span class="op">$</span><span class="va">cellnames</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">ga</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Single_data</span> <span class="op">&lt;-</span> <span class="va">Single_data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">scPagwas.gPAS.score</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">Single_data</span><span class="op">$</span><span class="va">scPagwas.gPAS.score</span><span class="op">&lt;-</span><span class="va">scPagwas.gPAS.score</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="compute-the-trs-and-background-correction-p-values">2.5 Compute the TRS and background correction p-values<a class="anchor" aria-label="anchor" href="#compute-the-trs-and-background-correction-p-values"></a>
</h4>
<p>This step is identical to the later steps in Solution 1.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">Single_data</span>, slot <span class="op">=</span> <span class="st">"data"</span>, assay <span class="op">=</span> <span class="st">"RNA"</span><span class="op">)</span></span>
<span><span class="va">gene_heritability_correlation</span><span class="op">&lt;-</span><span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Corr_Random.html">Corr_Random</a></span><span class="op">(</span><span class="va">data_mat</span>,</span>
<span>                                                     <span class="va">scPagwas.gPAS.score</span>,</span>
<span>                                                     seed<span class="op">=</span><span class="fl">1234</span>,</span>
<span>                                                     random<span class="op">=</span><span class="cn">T</span>,</span>
<span>                                                     Nrandom<span class="op">=</span><span class="fl">5</span>,</span>
<span>                                                     Nselect<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">scPagwas_topgenes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gene_heritability_correlation</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">gene_heritability_correlation</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">]</span></span>
<span><span class="va">Single_data</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://satijalab.org/seurat/reference/AddModuleScore.html" class="external-link">AddModuleScore</a></span><span class="op">(</span><span class="va">Single_data</span>,</span>
<span>        assay <span class="op">=</span> <span class="st">'RNA'</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">scPagwas_topgenes</span><span class="op">)</span>,</span>
<span>        name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"scPagwas.TRS.Score"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span><span class="va">correct_pdf</span> <span class="op">&lt;-</span> <span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Get_CorrectBg_p.html">Get_CorrectBg_p</a></span><span class="op">(</span>Single_data<span class="op">=</span><span class="va">Single_data</span>,</span>
<span>                                     scPagwas.TRS.Score<span class="op">=</span><span class="va">Single_data</span><span class="op">$</span><span class="va">scPagwas.TRS.Score1</span>,</span>
<span>                                     iters_singlecell<span class="op">=</span><span class="fl">100</span>,</span>
<span>                                     n_topgenes<span class="op">=</span><span class="fl">500</span>,</span>
<span>                                     scPagwas_topgenes<span class="op">=</span><span class="va">scPagwas_topgenes</span><span class="op">)</span></span>
<span><span class="va">Pagwas</span><span class="op">$</span><span class="va">scPagwas.TRS.Score</span> <span class="op">=</span> <span class="va">Single_data</span><span class="op">$</span><span class="va">scPagwas.TRS.Score1</span></span>
<span><span class="va">Pagwas</span><span class="op">$</span><span class="va">Random_Correct_BG_pdf</span> <span class="op">&lt;-</span> <span class="va">correct_pdf</span></span>
<span><span class="va">Pagwas</span><span class="op">$</span><span class="va">Merged_celltype_pvalue</span><span class="op">&lt;-</span><span class="fu">scPagwas</span><span class="fu">::</span><span class="fu"><a href="../reference/Merge_celltype_p.html">Merge_celltype_p</a></span><span class="op">(</span>single_p<span class="op">=</span><span class="va">correct_pdf</span><span class="op">$</span><span class="va">pooled_p</span>,</span>
<span>                                                          celltype<span class="op">=</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">Single_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#All the results can be found in the Pagwas result list.</span></span>
<span></span>
<span><span class="co">#output</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    scPagwas.TRS.Score <span class="op">=</span> <span class="va">Single_data</span><span class="op">$</span><span class="va">scPagwas.TRS.Score1</span>,</span>
<span>    scPagwas.gPAS.score <span class="op">=</span> <span class="va">scPagwas.gPAS.score</span>,</span>
<span>    Random_Correct_BG_p <span class="op">=</span> <span class="va">correct_pdf</span><span class="op">$</span><span class="va">pooled_p</span>,</span>
<span>    Random_Correct_BG_adjp <span class="op">=</span> <span class="va">correct_pdf</span><span class="op">$</span><span class="va">adj_p</span>,</span>
<span>    Random_Correct_BG_z <span class="op">=</span> <span class="va">correct_pdf</span><span class="op">$</span><span class="va">pooled_z</span><span class="op">)</span></span>
<span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">a</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"./"</span>, <span class="va">output.dirs</span>, <span class="st">"/singlecell_scPagwas_score_pvalue.Result.csv"</span><span class="op">)</span>,quote <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Chunyu Deng.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
